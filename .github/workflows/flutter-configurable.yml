name: Flutter CI (Configurable)

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:
    inputs:
      flutter_version:
        description: 'Flutter version to use'
        required: false
        default: '3.27.0'
        type: string

env:
  FLUTTER_VERSION: ${{ github.event.inputs.flutter_version || '3.27.0' }}
  # Use Flutter 3.27.0+ to ensure Dart 3.9.0+ compatibility
  # This version supports modern package requirements

jobs:
  verify-version:
    runs-on: ubuntu-latest
    outputs:
      flutter-version: ${{ steps.set-version.outputs.flutter-version }}
      dart-version: ${{ steps.verify-dart.outputs.dart-version }}
    steps:
    - name: Set Flutter version
      id: set-version
      run: |
        echo "flutter-version=${{ env.FLUTTER_VERSION }}" >> $GITHUB_OUTPUT
        echo "Using Flutter version: ${{ env.FLUTTER_VERSION }}"

    - name: Set up Flutter
      uses: subosito/flutter-action@v2
      with:
        flutter-version: ${{ env.FLUTTER_VERSION }}
        cache: true

    - name: Verify Dart version
      id: verify-dart
      run: |
        DART_VERSION=$(dart --version 2>&1 | head -n1 | cut -d' ' -f4)
        echo "dart-version=$DART_VERSION" >> $GITHUB_OUTPUT
        echo "Dart version: $DART_VERSION"
        
        # Check if Dart version meets minimum requirement (3.9.0)
        if [[ $(echo "$DART_VERSION 3.9.0" | tr " " "\n" | sort -V | head -n1) != "3.9.0" ]]; then
          echo "❌ ERROR: Dart version $DART_VERSION is below required 3.9.0"
          echo "Please update Flutter version to 3.27.0 or newer"
          exit 1
        else
          echo "✅ Dart version $DART_VERSION meets requirement (>=3.9.0)"
        fi

  test:
    runs-on: ubuntu-latest
    needs: verify-version

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        submodules: recursive

    - name: Set up Flutter
      uses: subosito/flutter-action@v2
      with:
        flutter-version: ${{ needs.verify-version.outputs.flutter-version }}
        cache: true

    - name: Display versions
      run: |
        echo "Flutter: ${{ needs.verify-version.outputs.flutter-version }}"
        echo "Dart: ${{ needs.verify-version.outputs.dart-version }}"
        flutter --version
        dart --version

    - name: Get dependencies
      run: flutter pub get

    - name: Verify dependencies
      run: flutter pub deps

    - name: Run tests
      run: flutter test --coverage

    - name: Analyze code
      run: flutter analyze

    - name: Check formatting
      run: dart format --output=none --set-exit-if-changed .

    - name: Upload coverage to Codecov
      uses: codecov/codecov-action@v4
      with:
        file: coverage/lcov.info
        fail_ci_if_error: false

  build:
    runs-on: ubuntu-latest
    needs: [verify-version, test]
    if: github.event_name == 'push' || github.event_name == 'workflow_dispatch'

    strategy:
      matrix:
        target: [apk, appbundle]

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        submodules: recursive

    - name: Set up Flutter
      uses: subosito/flutter-action@v2
      with:
        flutter-version: ${{ needs.verify-version.outputs.flutter-version }}
        cache: true

    - name: Set up Java
      uses: actions/setup-java@v4
      with:
        distribution: 'temurin'
        java-version: '17'

    - name: Get dependencies
      run: flutter pub get

    - name: Build ${{ matrix.target }}
      run: |
        if [ "${{ matrix.target }}" = "apk" ]; then
          flutter build apk --release
        else
          flutter build appbundle --release
        fi

    - name: Upload build artifacts
      uses: actions/upload-artifact@v4
      with:
        name: build-${{ matrix.target }}-flutter-${{ needs.verify-version.outputs.flutter-version }}
        path: |
          build/app/outputs/flutter-apk/*.apk
          build/app/outputs/bundle/release/*.aab
        retention-days: 30