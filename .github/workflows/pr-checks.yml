name: PR Checks

on:
  pull_request:
    branches: [ main, develop ]
    types: [opened, synchronize, reopened, ready_for_review]

env:
  FLUTTER_VERSION: "stable"
  JAVA_VERSION: "17"

# Cancel previous runs if a new push is made
concurrency:
  group: ${{ github.workflow }}-${{ github.event.pull_request.number || github.ref }}
  cancel-in-progress: true

jobs:
  # Quick code quality checks for fast PR feedback
  quick-checks:
    name: Quick Checks
    runs-on: ubuntu-latest
    timeout-minutes: 8
    if: github.event.pull_request.draft == false
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        # Fetch more history for better analysis
        fetch-depth: 0
    
    - name: Setup Java
      uses: actions/setup-java@v4
      with:
        distribution: 'temurin'
        java-version: ${{ env.JAVA_VERSION }}
    
    - name: Setup Flutter
      uses: subosito/flutter-action@v2
      with:
        flutter-version: ${{ env.FLUTTER_VERSION }}
        cache: true
    
    - name: Install dependencies
      run: flutter pub get
    
    - name: Check formatting
      run: |
        echo "Checking code formatting..."
        flutter format --set-exit-if-changed .
    
    - name: Flutter analyze
      run: |
        echo "Running Flutter analyze..."
        flutter analyze --fatal-infos
    
    - name: Check for merge conflicts
      run: |
        echo "Checking for merge conflict markers..."
        if grep -r "<<<<<<< \|======= \|>>>>>>> " --include="*.dart" --include="*.yaml" --include="*.yml" .; then
          echo "âŒ Merge conflict markers found!"
          exit 1
        else
          echo "âœ… No merge conflict markers found"
        fi

  # Unit tests for PR validation
  unit-tests:
    name: Unit Tests
    runs-on: ubuntu-latest
    timeout-minutes: 12
    if: github.event.pull_request.draft == false
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Setup Java
      uses: actions/setup-java@v4
      with:
        distribution: 'temurin'
        java-version: ${{ env.JAVA_VERSION }}
    
    - name: Setup Flutter
      uses: subosito/flutter-action@v2
      with:
        flutter-version: ${{ env.FLUTTER_VERSION }}
        cache: true
    
    - name: Install dependencies
      run: flutter pub get
    
    - name: Run unit tests
      run: |
        echo "Running unit tests..."
        flutter test --reporter=expanded --coverage
    
    - name: Check test coverage
      run: |
        echo "Checking test coverage..."
        if [ -f "coverage/lcov.info" ]; then
          echo "âœ… Coverage report generated"
          # Simple coverage check - more sophisticated tools can be added later
          lines_covered=$(grep -c "LF:" coverage/lcov.info)
          echo "Lines covered: $lines_covered"
        else
          echo "âš ï¸ No coverage report found"
        fi

  # Quick build verification
  build-check:
    name: Build Check
    runs-on: ubuntu-latest
    timeout-minutes: 15
    if: github.event.pull_request.draft == false
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Setup Java
      uses: actions/setup-java@v4
      with:
        distribution: 'temurin'
        java-version: ${{ env.JAVA_VERSION }}
    
    - name: Setup Flutter
      uses: subosito/flutter-action@v2
      with:
        flutter-version: ${{ env.FLUTTER_VERSION }}
        cache: true
    
    - name: Install dependencies
      run: flutter pub get
    
    - name: Build debug APK
      run: |
        echo "Building debug APK..."
        flutter build apk --debug
        echo "âœ… Debug build successful"
        ls -la build/app/outputs/flutter-apk/

  # Dependency security check
  security-check:
    name: Security Check
    runs-on: ubuntu-latest
    timeout-minutes: 5
    if: github.event.pull_request.draft == false
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Setup Flutter
      uses: subosito/flutter-action@v2
      with:
        flutter-version: ${{ env.FLUTTER_VERSION }}
        cache: true
    
    - name: Install dependencies
      run: flutter pub get
    
    - name: Check for outdated dependencies
      run: |
        echo "Checking for outdated dependencies..."
        flutter pub outdated
    
    - name: Check pubspec.lock for security issues
      run: |
        echo "Checking pubspec.lock..."
        if [ -f "pubspec.lock" ]; then
          echo "âœ… pubspec.lock exists"
          # Basic check for known problematic packages
          if grep -i "http.*0\." pubspec.lock; then
            echo "âš ï¸ Found potentially insecure http package versions"
          fi
        else
          echo "âŒ pubspec.lock not found"
          exit 1
        fi

  # PR size and structure check
  pr-analysis:
    name: PR Analysis
    runs-on: ubuntu-latest
    timeout-minutes: 3
    if: github.event.pull_request.draft == false
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
    
    - name: Analyze PR size
      run: |
        echo "Analyzing PR size and structure..."
        
        # Get changed files
        files_changed=$(git diff --name-only origin/${{ github.event.pull_request.base.ref }}...HEAD | wc -l)
        lines_changed=$(git diff --stat origin/${{ github.event.pull_request.base.ref }}...HEAD | tail -1)
        
        echo "Files changed: $files_changed"
        echo "Lines changed: $lines_changed"
        
        # Check PR size
        if [ "$files_changed" -gt 50 ]; then
          echo "âš ï¸ Large PR: Consider breaking into smaller PRs"
          echo "FILES_CHANGED_WARNING=true" >> $GITHUB_ENV
        else
          echo "âœ… PR size looks good"
        fi
        
        # Check for test files
        test_files=$(git diff --name-only origin/${{ github.event.pull_request.base.ref }}...HEAD | grep -E "(test|spec)" | wc -l)
        dart_files=$(git diff --name-only origin/${{ github.event.pull_request.base.ref }}...HEAD | grep "\.dart$" | grep -v test | wc -l)
        
        if [ "$dart_files" -gt 0 ] && [ "$test_files" -eq 0 ]; then
          echo "âš ï¸ No test files found - consider adding tests"
          echo "NO_TESTS_WARNING=true" >> $GITHUB_ENV
        else
          echo "âœ… Test files found or no Dart changes"
        fi
    
    - name: Comment on PR if needed
      if: env.FILES_CHANGED_WARNING == 'true' || env.NO_TESTS_WARNING == 'true'
      uses: actions/github-script@v7
      with:
        script: |
          let warnings = [];
          
          if (process.env.FILES_CHANGED_WARNING === 'true') {
            warnings.push('âš ï¸ **Large PR**: This PR changes many files. Consider breaking it into smaller, focused PRs.');
          }
          
          if (process.env.NO_TESTS_WARNING === 'true') {
            warnings.push('âš ï¸ **Missing Tests**: This PR modifies Dart code but doesn\'t include test files. Consider adding tests.');
          }
          
          if (warnings.length > 0) {
            const body = `## PR Analysis\n\n${warnings.join('\n\n')}\n\n*This is an automated message*`;
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: body
            });
          }

  # Summary job that all other jobs depend on
  pr-checks-summary:
    name: PR Checks Summary
    runs-on: ubuntu-latest
    if: always() && github.event.pull_request.draft == false
    needs: [quick-checks, unit-tests, build-check, security-check, pr-analysis]
    
    steps:
    - name: Check overall status
      run: |
        echo "## PR Checks Summary" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        # Check each job status
        if [ "${{ needs.quick-checks.result }}" == "success" ]; then
          echo "âœ… Quick Checks: Passed" >> $GITHUB_STEP_SUMMARY
        else
          echo "âŒ Quick Checks: Failed" >> $GITHUB_STEP_SUMMARY
        fi
        
        if [ "${{ needs.unit-tests.result }}" == "success" ]; then
          echo "âœ… Unit Tests: Passed" >> $GITHUB_STEP_SUMMARY
        else
          echo "âŒ Unit Tests: Failed" >> $GITHUB_STEP_SUMMARY
        fi
        
        if [ "${{ needs.build-check.result }}" == "success" ]; then
          echo "âœ… Build Check: Passed" >> $GITHUB_STEP_SUMMARY
        else
          echo "âŒ Build Check: Failed" >> $GITHUB_STEP_SUMMARY
        fi
        
        if [ "${{ needs.security-check.result }}" == "success" ]; then
          echo "âœ… Security Check: Passed" >> $GITHUB_STEP_SUMMARY
        else
          echo "âŒ Security Check: Failed" >> $GITHUB_STEP_SUMMARY
        fi
        
        if [ "${{ needs.pr-analysis.result }}" == "success" ]; then
          echo "âœ… PR Analysis: Completed" >> $GITHUB_STEP_SUMMARY
        else
          echo "âŒ PR Analysis: Failed" >> $GITHUB_STEP_SUMMARY
        fi
        
        echo "" >> $GITHUB_STEP_SUMMARY
        
        # Determine overall status
        if [ "${{ needs.quick-checks.result }}" == "success" ] && \
           [ "${{ needs.unit-tests.result }}" == "success" ] && \
           [ "${{ needs.build-check.result }}" == "success" ] && \
           [ "${{ needs.security-check.result }}" == "success" ]; then
          echo "ðŸŽ‰ **Overall Status: READY FOR REVIEW**" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "All checks passed! This PR is ready for code review." >> $GITHUB_STEP_SUMMARY
          exit 0
        else
          echo "ðŸ’¥ **Overall Status: NEEDS FIXES**" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Some checks failed. Please review the failed jobs and fix the issues." >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Next Steps:**" >> $GITHUB_STEP_SUMMARY
          echo "1. Click on failed job details above" >> $GITHUB_STEP_SUMMARY
          echo "2. Fix the reported issues" >> $GITHUB_STEP_SUMMARY
          echo "3. Push your fixes to re-run checks" >> $GITHUB_STEP_SUMMARY
          exit 1
        fi